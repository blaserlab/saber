<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Construct a Saber object from CRISPR barcode data — make.Saber • saber</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Construct a Saber object from CRISPR barcode data — make.Saber"><meta name="description" content="Build a Saber object from a CrispRVariants crispr_set
by estimating empirical noise thresholds, identifying stereotyped recurrent
barcode variants using a permutation-based test and entropy filter, and
summarizing per-sample and per-variant quality metrics."><meta property="og:description" content="Build a Saber object from a CrispRVariants crispr_set
by estimating empirical noise thresholds, identifying stereotyped recurrent
barcode variants using a permutation-based test and entropy filter, and
summarizing per-sample and per-variant quality metrics."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">saber</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9007</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/blaserlab/saber/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Construct a <code>Saber</code> object from CRISPR barcode data</h1>
      <small class="dont-index">Source: <a href="https://github.com/blaserlab/saber/blob/HEAD/R/saber_constructor.R" class="external-link"><code>R/saber_constructor.R</code></a></small>
      <div class="d-none name"><code>make.Saber.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Build a <code>Saber</code> object from a <code>CrispRVariants</code> <code>crispr_set</code>
by estimating empirical noise thresholds, identifying stereotyped recurrent
barcode variants using a permutation-based test and entropy filter, and
summarizing per-sample and per-variant quality metrics.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">make.Saber</span><span class="op">(</span></span>
<span>  <span class="va">crispr_set</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"No description provided."</span>,</span>
<span>  min_sample_depth <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  background_count <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  background_freq <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>  depths <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  no_variant_pattern <span class="op">=</span> <span class="st">"^no variant$"</span>,</span>
<span>  thresholds <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  min_samples <span class="op">=</span> <span class="fl">2L</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  background <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"singletons"</span>, <span class="st">"all"</span><span class="op">)</span>,</span>
<span>  noise_quantile <span class="op">=</span> <span class="fl">0.99</span>,</span>
<span>  entropy_thresh <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  B <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  progress <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-crispr-set">crispr_set<a class="anchor" aria-label="anchor" href="#arg-crispr-set"></a></dt>
<dd><p>A <code>CrispRVariants</code> <code>crisprSet</code> (or similar)
object from which variant count matrices can be extracted via
<code><a href="https://rdrr.io/pkg/CrispRVariants/man/variantCounts.html" class="external-link">CrispRVariants::variantCounts()</a></code>.</p></dd>


<dt id="arg-description">description<a class="anchor" aria-label="anchor" href="#arg-description"></a></dt>
<dd><p>Character scalar describing the analysis or dataset.</p></dd>


<dt id="arg-min-sample-depth">min_sample_depth<a class="anchor" aria-label="anchor" href="#arg-min-sample-depth"></a></dt>
<dd><p>Numeric scalar; samples with total depth (column
sum) below this value are excluded prior to analysis.</p></dd>


<dt id="arg-background-count">background_count<a class="anchor" aria-label="anchor" href="#arg-background-count"></a></dt>
<dd><p>Integer count threshold used when computing
per-variant collision probabilities (background model).</p></dd>


<dt id="arg-background-freq">background_freq<a class="anchor" aria-label="anchor" href="#arg-background-freq"></a></dt>
<dd><p>Numeric VAF threshold used when computing
per-variant collision probabilities (background model).</p></dd>


<dt id="arg-depths">depths<a class="anchor" aria-label="anchor" href="#arg-depths"></a></dt>
<dd><p>Optional numeric vector of per-sample depths. If <code>NULL</code>,
computed as <code>colSums(count_mat)</code>.</p></dd>


<dt id="arg-no-variant-pattern">no_variant_pattern<a class="anchor" aria-label="anchor" href="#arg-no-variant-pattern"></a></dt>
<dd><p>Character scalar, regular expression used to
identify rows corresponding to "no variant" background.</p></dd>


<dt id="arg-thresholds">thresholds<a class="anchor" aria-label="anchor" href="#arg-thresholds"></a></dt>
<dd><p>Optional list as returned by
<code><a href="estimate_barcode_thresholds.html">estimate_barcode_thresholds()</a></code>. If <code>NULL</code>, thresholds are
estimated from the data (recommended).</p></dd>


<dt id="arg-min-samples">min_samples<a class="anchor" aria-label="anchor" href="#arg-min-samples"></a></dt>
<dd><p>Integer; minimum number of samples in which a variant
must be present (after thresholding) to be considered for recurrent
filtering.</p></dd>


<dt id="arg-alpha">alpha<a class="anchor" aria-label="anchor" href="#arg-alpha"></a></dt>
<dd><p>Numeric scalar; FDR threshold applied to permutation-based
empirical p-values when calling recurrent variants.</p></dd>


<dt id="arg-background">background<a class="anchor" aria-label="anchor" href="#arg-background"></a></dt>
<dd><p>Character scalar specifying how to define background when
estimating noise thresholds; either <code>"singletons"</code> or <code>"all"</code>.</p></dd>


<dt id="arg-noise-quantile">noise_quantile<a class="anchor" aria-label="anchor" href="#arg-noise-quantile"></a></dt>
<dd><p>Numeric scalar in \((0, 1)\); quantile of empirical
count and VAF distributions used as noise upper bound.</p></dd>


<dt id="arg-entropy-thresh">entropy_thresh<a class="anchor" aria-label="anchor" href="#arg-entropy-thresh"></a></dt>
<dd><p>Numeric scalar in \([0, 1]\); variants with
normalized entropy greater than or equal to this value (i.e. more evenly
distributed across samples) are more likely to be treated as stereotyped
junk when also recurrent and significant in the permutation test.</p></dd>


<dt id="arg-b">B<a class="anchor" aria-label="anchor" href="#arg-b"></a></dt>
<dd><p>Integer; number of permutations used to estimate empirical
p-values for variant recurrence.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>Optional integer random seed passed to <code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code> for
reproducibility of the permutation procedure.</p></dd>


<dt id="arg-progress">progress<a class="anchor" aria-label="anchor" href="#arg-progress"></a></dt>
<dd><p>Logical; if <code>TRUE</code>, progress messages are printed
during the permutation loop.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A <code>Saber</code> object (S7/R7 class defined elsewhere) containing:</p><ul><li><p><code>description</code>: Analysis description.</p></li>
<li><p><code>filtered_counts</code>: Matrix of counts with stereotyped junk and
no-variant rows removed.</p></li>
<li><p><code>recurrent_variants</code>: Data frame of per-variant recurrence and
entropy statistics.</p></li>
<li><p><code>motif_blacklist</code>: Character vector of variant IDs treated as
uninformative (recurrent or no-variant).</p></li>
<li><p><code>per_sample_uniques</code>: Data frame of unique barcodes per sample.</p></li>
<li><p><code>per_sample_qc</code>: Data frame of per-sample QC metrics.</p></li>
<li><p><code>per_variant_qc</code>: Tibble of per-variant collision probabilities
based on the background model.</p></li>
<li><p><code>thresholds</code>: List of thresholds and analysis parameters.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The workflow implemented by <code>make.Saber()</code> is:</p><ol><li><p>Extract a variant count matrix from <code>crispr_set</code> and drop
samples with depth below <code>min_sample_depth</code>.</p></li>
<li><p>Estimate empirical <code>count_thresh</code> and <code>freq_thresh</code> using
<code><a href="estimate_barcode_thresholds.html">estimate_barcode_thresholds()</a></code> if <code>thresholds</code> is
<code>NULL</code>.</p></li>
<li><p>Define variant presence using these thresholds, and exclude
<code>"no variant"</code> rows.</p></li>
<li><p>For each variant, compute the number of samples in which it is
present and its normalized entropy across samples.</p></li>
<li><p>Perform a permutation-based recurrence test by shuffling the
presence matrix within columns <code>B</code> times, deriving empirical
p-values and FDR-adjusted p-values.</p></li>
<li><p>Define stereotyped recurrent variants (<code>is_recurrent</code>) as those
that (i) are not <code>"no variant"</code>, (ii) are present in at least
<code>min_samples</code> samples, (iii) are significant at FDR
<code>alpha</code>, and (iv) have entropy greater than or equal to
<code>entropy_thresh</code>.</p></li>
<li><p>Remove <code>"no variant"</code> rows and recurrent stereotyped variants
to obtain <code>filtered_counts</code>.</p></li>
<li><p>Summarize per-sample metrics (total reads, fractions in kept,
recurrent, and no-variant reads, unique barcodes, entropy before
and after filtering).</p></li>
<li><p>Compute per-variant collision probabilities on the filtered matrix
using <code><a href="estimate_barcode_collision_probs.html">estimate_barcode_collision_probs()</a></code> with
<code>background_count</code> and <code>background_freq</code>.</p></li>
<li><p>Construct and return a <code>Saber</code> object with all of these
components.</p></li>
</ol></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="https://rdrr.io/pkg/CrispRVariants/man/variantCounts.html" class="external-link">CrispRVariants::variantCounts()</a></code>, <code><a href="estimate_barcode_thresholds.html">estimate_barcode_thresholds()</a></code>,
<code><a href="estimate_barcode_collision_probs.html">estimate_barcode_collision_probs()</a></code></p></div>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Brad Blaser.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>


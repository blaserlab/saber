% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/saber_constructor.R
\name{make.Saber}
\alias{make.Saber}
\title{Construct a \code{Saber} object from CRISPR barcode data}
\usage{
make.Saber(
  crispr_set,
  description = "No description provided.",
  min_sample_depth = 1000,
  background_count = 100,
  background_freq = 0.001,
  depths = NULL,
  no_variant_pattern = "^no variant$",
  thresholds = NULL,
  min_samples = 2L,
  alpha = 0.05,
  background = c("singletons", "all"),
  noise_quantile = 0.99,
  entropy_thresh = 0.8,
  B = 1000L,
  seed = NULL,
  progress = TRUE
)
}
\arguments{
\item{crispr_set}{A \code{CrispRVariants} \code{crisprSet} (or similar)
object from which variant count matrices can be extracted via
\code{CrispRVariants::variantCounts()}.}

\item{description}{Character scalar describing the analysis or dataset.}

\item{min_sample_depth}{Numeric scalar; samples with total depth (column
sum) below this value are excluded prior to analysis.}

\item{background_count}{Integer count threshold used when computing
per-variant collision probabilities (background model).}

\item{background_freq}{Numeric VAF threshold used when computing
per-variant collision probabilities (background model).}

\item{depths}{Optional numeric vector of per-sample depths. If \code{NULL},
computed as \code{colSums(count_mat)}.}

\item{no_variant_pattern}{Character scalar, regular expression used to
identify rows corresponding to "no variant" background.}

\item{thresholds}{Optional list as returned by
\code{estimate_barcode_thresholds()}. If \code{NULL}, thresholds are
estimated from the data (recommended).}

\item{min_samples}{Integer; minimum number of samples in which a variant
must be present (after thresholding) to be considered for recurrent
filtering.}

\item{alpha}{Numeric scalar; FDR threshold applied to permutation-based
empirical p-values when calling recurrent variants.}

\item{background}{Character scalar specifying how to define background when
estimating noise thresholds; either \code{"singletons"} or \code{"all"}.}

\item{noise_quantile}{Numeric scalar in \eqn{(0, 1)}; quantile of empirical
count and VAF distributions used as noise upper bound.}

\item{entropy_thresh}{Numeric scalar in \eqn{[0, 1]}; variants with
normalized entropy greater than or equal to this value (i.e. more evenly
distributed across samples) are more likely to be treated as stereotyped
junk when also recurrent and significant in the permutation test.}

\item{B}{Integer; number of permutations used to estimate empirical
p-values for variant recurrence.}

\item{seed}{Optional integer random seed passed to \code{set.seed()} for
reproducibility of the permutation procedure.}

\item{progress}{Logical; if \code{TRUE}, progress messages are printed
during the permutation loop.}
}
\value{
A \code{Saber} object (S7/R7 class defined elsewhere) containing:
\itemize{
\item \code{description}: Analysis description.
\item \code{filtered_counts}: Matrix of counts with stereotyped junk and
no-variant rows removed.
\item \code{recurrent_variants}: Data frame of per-variant recurrence and
entropy statistics.
\item \code{motif_blacklist}: Character vector of variant IDs treated as
uninformative (recurrent or no-variant).
\item \code{per_sample_uniques}: Data frame of unique barcodes per sample.
\item \code{per_sample_qc}: Data frame of per-sample QC metrics.
\item \code{per_variant_qc}: Tibble of per-variant collision probabilities
based on the background model.
\item \code{thresholds}: List of thresholds and analysis parameters.
}
}
\description{
Build a \code{Saber} object from a \code{CrispRVariants} \code{crispr_set}
by estimating empirical noise thresholds, identifying stereotyped recurrent
barcode variants using a permutation-based test and entropy filter, and
summarizing per-sample and per-variant quality metrics.
}
\details{
The workflow implemented by \code{make.Saber()} is:
\enumerate{
\item Extract a variant count matrix from \code{crispr_set} and drop
samples with depth below \code{min_sample_depth}.
\item Estimate empirical \code{count_thresh} and \code{freq_thresh} using
\code{estimate_barcode_thresholds()} if \code{thresholds} is
\code{NULL}.
\item Define variant presence using these thresholds, and exclude
\code{"no variant"} rows.
\item For each variant, compute the number of samples in which it is
present and its normalized entropy across samples.
\item Perform a permutation-based recurrence test by shuffling the
presence matrix within columns \code{B} times, deriving empirical
p-values and FDR-adjusted p-values.
\item Define stereotyped recurrent variants (\code{is_recurrent}) as those
that (i) are not \code{"no variant"}, (ii) are present in at least
\code{min_samples} samples, (iii) are significant at FDR
\code{alpha}, and (iv) have entropy greater than or equal to
\code{entropy_thresh}.
\item Remove \code{"no variant"} rows and recurrent stereotyped variants
to obtain \code{filtered_counts}.
\item Summarize per-sample metrics (total reads, fractions in kept,
recurrent, and no-variant reads, unique barcodes, entropy before
and after filtering).
\item Compute per-variant collision probabilities on the filtered matrix
using \code{estimate_barcode_collision_probs()} with
\code{background_count} and \code{background_freq}.
\item Construct and return a \code{Saber} object with all of these
components.
}
}
\seealso{
\code{CrispRVariants::variantCounts()}, \code{estimate_barcode_thresholds()},
\code{estimate_barcode_collision_probs()}
}
